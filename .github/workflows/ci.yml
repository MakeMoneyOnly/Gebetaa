name: CI Pipeline

on:
    pull_request:
        branches: [main, develop]
    push:
        branches: [main, develop]

env:
    NODE_VERSION: '20'

jobs:
    # ========================================
    # SKILL: QA.Auto - Lint & Type Check
    # ========================================
    lint:
        name: Lint & Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run ESLint
              run: pnpm run lint

            - name: Run TypeScript type check
              run: pnpm run type-check

            - name: Run Prettier check
              run: pnpm run format:check

    # ========================================
    # SKILL: QA.Auto - Unit Tests
    # ========================================
    unit-tests:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run unit tests
              run: pnpm run test -- --coverage

    # ========================================
    # SKILL: QA.Auto - Integration Tests
    # ========================================
    integration-tests:
        name: Integration Tests
        runs-on: ubuntu-latest
        needs: [unit-tests]
        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_PASSWORD: postgres
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            # Note: We need a script for this, or just skip if not ready
            # - name: Run integration tests
            #   run: pnpm run test:integration
            #   env:
            #     DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

    # ========================================
    # SKILL: QA.Auto - E2E Tests
    # ========================================
    e2e-tests:
        name: E2E Tests
        runs-on: ubuntu-latest
        needs: [unit-tests]
        env:
            NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Install Playwright
              run: pnpm exec playwright install --with-deps

            - name: Run E2E tests
              run: pnpm run test:e2e

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-report
                  path: playwright-report/

    # ========================================
    # SKILL: Security.Gate - Security Scan
    # ========================================
    security:
        name: Security Scan
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run npm audit
              run: pnpm audit --audit-level=moderate

    # ========================================
    # SKILL: DevOps.SRE - Build
    # ========================================
    build:
        name: Build Application
        runs-on: ubuntu-latest
        needs: [unit-tests, integration-tests, e2e-tests, security]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build application
              run: pnpm run build
              env:
                  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
                  NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY }}

            - name: Verify build output
              run: |
                  if [ -d ".next" ]; then
                    echo "✅ Build output directory exists"
                  else
                    echo "❌ Build output directory missing"
                    exit 1
                  fi

            # - name: Check bundle size
            #   run: pnpm run check:bundle-size

    # ========================================
    # SKILL: Performance.Optimization - Lighthouse CI
    # ========================================
    lighthouse:
        name: Lighthouse Performance Audit
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build application
              run: pnpm run build
              env:
                  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
                  NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY }}

            - name: Run Lighthouse CI
              uses: treosh/lighthouse-ci-action@v10
              env:
                  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
                  NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY }}
              with:
                  urls: |
                      http://localhost:3000
                      http://localhost:3000/m/demo-table
                  uploadArtifacts: false
                  temporaryPublicStorage: false
                  budgetPath: ./lighthouse-budget.json
                  configPath: ./lighthouserc.json

            - name: Upload Lighthouse results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: lighthouse-results
                  path: .lighthouseci/
                  retention-days: 14

    # ========================================
    # Summary Report
    # ========================================
    summary:
        name: CI Summary
        runs-on: ubuntu-latest
        needs: [lint, unit-tests, integration-tests, e2e-tests, security, build, lighthouse]
        if: always()
        steps:
            - name: Check all jobs
              run: |
                  if [ "${{ needs.lint.result }}" != "success" ]; then
                    echo "❌ Lint failed"
                    exit 1
                  fi
                  if [ "${{ needs.unit-tests.result }}" != "success" ]; then
                    echo "❌ Unit tests failed"
                    exit 1
                  fi
                  if [ "${{ needs.integration-tests.result }}" != "success" ]; then
                    echo "❌ Integration tests failed"
                    exit 1
                  fi
                  if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
                    echo "❌ E2E tests failed"
                    exit 1
                  fi
                  if [ "${{ needs.security.result }}" != "success" ]; then
                    echo "❌ Security scan failed"
                    exit 1
                  fi
                  if [ "${{ needs.build.result }}" != "success" ]; then
                    echo "❌ Build failed"
                    exit 1
                  fi
                  echo "✅ All CI checks passed!"
