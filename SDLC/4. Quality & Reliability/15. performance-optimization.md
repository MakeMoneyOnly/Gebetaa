# SKILL: performance-optimization

## Purpose

Identify performance bottlenecks and implement optimizations for speed, accessibility, and SEO. This skill covers measurement, analysis, and implementation of performance improvements across the full stack.

## When to Use

- When Core Web Vitals need improvement
- When users report slowness
- Before major launches
- During performance audits
- When scaling requires optimization

## Role Activated

**Senior Performance Engineer + Web Vitals Specialist**

You think like engineers at Google's Chrome team—obsessed with milliseconds and user-perceived performance.

## Inputs (Variables)

````yaml
{current_metrics}: Lighthouse scores, Core Web Vitals
{performance_budget}: Target metrics
{bottleneck_reports}: Known slow areas
{user_complaints}: Reported performance issues
{infrastructure}: Hosting, CDN, database

Step-by-Step Process
Step 1: Performance Measurement
markdownDownloadCopy code## Core Web Vitals Targets

| Metric | Good | Needs Improvement | Poor |
|--------|------|-------------------|------|
| LCP (Largest Contentful Paint) | ≤ 2.5s | ≤ 4.0s | > 4.0s |
| INP (Interaction to Next Paint) | ≤ 200ms | ≤ 500ms | > 500ms |
| CLS (Cumulative Layout Shift) | ≤ 0.1 | ≤ 0.25 | > 0.25 |
| FCP (First Contentful Paint) | ≤ 1.8s | ≤ 3.0s | > 3.0s |
| TTFB (Time to First Byte) | ≤ 800ms | ≤ 1.8s | > 1.8s |

## Measurement Tools

### Lab Testing
- Lighthouse (Chrome DevTools)
- WebPageTest
- PageSpeed Insights

### Field Data (RUM)
- Chrome User Experience Report (CrUX)
- Custom RUM implementation
- Analytics integration
typescriptDownloadCopy code// Real User Monitoring implementation
const reportWebVitals = () => {
  if (typeof window === 'undefined') return;

  import('web-vitals').then(({ onCLS, onINP, onLCP, onFCP, onTTFB }) => {
    const sendToAnalytics = (metric: Metric) => {
      const body = JSON.stringify({
        name: metric.name,
        value: metric.value,
        rating: metric.rating,
        delta: metric.delta,
        id: metric.id,
        navigationType: metric.navigationType,
        url: window.location.href,
        userAgent: navigator.userAgent,
      });

      // Use sendBeacon for reliable delivery
      if (navigator.sendBeacon) {
        navigator.sendBeacon('/api/analytics/vitals', body);
      } else {
        fetch('/api/analytics/vitals', {
          body,
          method: 'POST',
          keepalive: true,
        });
      }
    };

    onCLS(sendToAnalytics);
    onINP(sendToAnalytics);
    onLCP(sendToAnalytics);
    onFCP(sendToAnalytics);
    onTTFB(sendToAnalytics);
  });
};
Step 2: Frontend Optimization
typescriptDownloadCopy code// Image Optimization
import Image from 'next/image';

// ❌ Bad
<img src="/hero.png" />

// ✅ Good - Optimized with Next.js Image
<Image
  src="/hero.png"
  alt="Hero image"
  width={1200}
  height={600}
  priority // For above-fold images
  placeholder="blur"
  blurDataURL="data:image/jpeg;base64,..."
  sizes="(max-width: 768px) 100vw, 1200px"
/>

// Font Optimization
import { Inter } from 'next/font/google';

const inter = Inter({
  subsets: ['latin'],
  display: 'swap', // Prevent FOIT
  preload: true,
  variable: '--font-inter',
});

// Critical CSS
// next.config.js
module.exports = {
  experimental: {
    optimizeCss: true,
  },
};

// Code Splitting
const HeavyComponent = dynamic(
  () => import('@/components/HeavyComponent'),
  {
    loading: () => <Skeleton />,
    ssr: false,
  }
);

// Lazy loading below fold content
const BelowFold = dynamic(
  () => import('@/components/BelowFold'),
  { loading: () => <Skeleton /> }
);
cssDownloadCopy code/* CSS Performance */

/* Use contain for complex components */
.card {
  contain: layout style paint;
}

/* Avoid layout thrashing */
.animated {
  will-change: transform;
  transform: translateZ(0); /* Force GPU layer */
}

/* Efficient selectors */
/* ❌ Bad - expensive selector */
div.container ul li a.link { }

/* ✅ Good - simple selector */
.nav-link { }

/* Reduce repaints with opacity/transform */
/* ❌ Bad - triggers layout */
.hidden { display: none; }

/* ✅ Good - only triggers composite */
.hidden {
  opacity: 0;
  pointer-events: none;
}
Step 3: JavaScript Optimization
typescriptDownloadCopy code// Bundle optimization
// Analyze bundle
// npm run build -- --analyze

// Tree shaking - import only what you need
// ❌ Bad
import _ from 'lodash';
_.debounce(fn, 300);

// ✅ Good
import debounce from 'lodash/debounce';
debounce(fn, 300);

// Memoization
import { useMemo, useCallback, memo } from 'react';

// Memoize expensive calculations
const ExpensiveComponent = memo(function ExpensiveComponent({ data }) {
  const processedData = useMemo(
    () => expensiveOperation(data),
    [data]
  );

  const handleClick = useCallback(() => {
    // Handler logic
  }, []);

  return <div onClick={handleClick}>{processedData}</div>;
});

// Virtual scrolling for long lists
import { useVirtualizer } from '@tanstack/react-virtual';

function VirtualList({ items }) {
  const parentRef = useRef<HTMLDivElement>(null);

  const virtualizer = useVirtualizer({
    count: items.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 50,
    overscan: 5,
  });

  return (
    <div ref={parentRef} style={{ height: '400px', overflow: 'auto' }}>
      <div style={{ height: `${virtualizer.getTotalSize()}px`, position: 'relative' }}>
        {virtualizer.getVirtualItems().map((virtualItem) => (
          <div
            key={virtualItem.key}
            style={{
              position: 'absolute',
              top: 0,
              transform: `translateY(${virtualItem.start}px)`,
              height: `${virtualItem.size}px`,
            }}
          >
            {items[virtualItem.index]}
          </div>
        ))}
      </div>
    </div>
  );
}
Step 4: Backend Optimization
typescriptDownloadCopy code// Database query optimization
// ❌ Bad - N+1 query
const users = await prisma.user.findMany();
for (const user of users) {
  const projects = await prisma.project.findMany({
    where: { userId: user.id }
  });
}

// ✅ Good - Single query with include
const users = await prisma.user.findMany({
  include: { projects: true }
});

// ✅ Better - Select only needed fields
const users = await prisma.user.findMany({
  select: {
    id: true,
    name: true,
    projects: {
      select: { id: true, name: true }
    }
  }
});

// Caching
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);
const CACHE_TTL = 60 * 5; // 5 minutes

async function getCachedData<T>(
  key: string,
  fetcher: () => Promise<T>
): Promise<T> {
  // Try cache first
  const cached = await redis.get(key);
  if (cached) {
    return JSON.parse(cached);
  }

  // Fetch fresh data
  const data = await fetcher();

  // Cache for next time
  await redis.setex(key, CACHE_TTL, JSON.stringify(data));

  return data;
}

// Usage
const projects = await getCachedData(
  `user:${userId}:projects`,
  () => prisma.project.findMany({ where: { userId } })
);

// Connection pooling
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
  // Connection pool settings
  log: ['query', 'warn', 'error'],
});
Step 5: Infrastructure Optimization
markdownDownloadCopy code## CDN & Caching Strategy

### Cache Headers
```typescript
// next.config.js
module.exports = {
  async headers() {
    return [
      {
        source: '/static/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
      {
        source: '/api/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'no-store, must-revalidate',
          },
        ],
      },
    ];
  },
};
Edge Caching
typescriptDownloadCopy code// Vercel Edge Config
export const config = {
  runtime: 'edge',
};

export default async function handler(request: Request) {
  return new Response(JSON.stringify({ data: 'fast' }), {
    headers: {
      'Content-Type': 'application/json',
      'Cache-Control': 's-maxage=60, stale-while-revalidate=300',
    },
  });
}
Database Optimization
sqlDownloadCopy code-- Add indexes for common queries
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_projects_created_at ON projects(created_at DESC);

-- Composite index for common filter + sort
CREATE INDEX idx_projects_user_status_created
ON projects(user_id, status, created_at DESC);

-- Analyze query performance
EXPLAIN ANALYZE SELECT * FROM projects WHERE user_id = 'x' ORDER BY created_at DESC LIMIT 20;

### Step 6: Performance Budget

```markdown
## Performance Budget

### Bundle Size Budget
| Asset Type | Budget | Current | Status |
|------------|--------|---------|--------|
| Initial JS | < 100KB | | |
| Per-route JS | < 50KB | | |
| CSS | < 30KB | | |
| Images (above fold) | < 200KB | | |
| Fonts | < 100KB | | |

### Runtime Budget
| Metric | Budget | Current | Status |
|--------|--------|---------|--------|
| LCP | < 2.5s | | |
| INP | < 200ms | | |
| CLS | < 0.1 | | |
| Total Blocking Time | < 300ms | | |

### CI Budget Enforcement
```javascript
// lighthouse-ci.config.js
module.exports = {
  ci: {
    assert: {
      assertions: {
        'categories:performance': ['error', { minScore: 0.9 }],
        'first-contentful-paint': ['error', { maxNumericValue: 1800 }],
        'largest-contentful-paint': ['error', { maxNumericValue: 2500 }],
        'cumulative-layout-shift': ['error', { maxNumericValue: 0.1 }],
        'total-blocking-time': ['error', { maxNumericValue: 300 }],
      },
    },
  },
};


## Outputs

1. **Performance Baseline** - Current metrics documented
2. **Optimization Plan** - Prioritized improvements
3. **Implementation** - Code optimizations
4. **Infrastructure Config** - CDN, caching setup
5. **Performance Budget** - Ongoing enforcement
6. **Monitoring** - RUM implementation

## Quality Gates

| Gate | Criteria | Status |
|------|----------|--------|
| LCP | < 2.5s on 75th percentile | |
| INP | < 200ms on 75th percentile | |
| CLS | < 0.1 on 75th percentile | |
| Lighthouse | > 90 performance score | |
| Bundle | Within budget | |

## References & Best Practices

### From Google Web.dev
- "Performance is about retaining users."
- Core Web Vitals are ranking factors.

### From The Pragmatic Engineer
- "Measure first, optimize second."
- "The fastest code is code that doesn't run."
````
